#!/usr/bin/env node

var argv = require('minimist')(process.argv.slice(2), {
  boolean: ['dryRun', 'ignoreEmpty', 'csv', 'headerline'],
  alias: {
    key: 'k',
    separator: 's'
  }
})

var defined = require('defined')
var mongojs = require('mongojs')
var csv = require('csv-parser')
var EJSON = require('mongodb-extended-json')
var async = require('async')
var debug = require('debug')('mongomerge')
var update = require('../')

var ignoreEmpty = argv.ignoreEmpty

var header = defined(argv.header, true)
var ignoreEmpty = defined(argv.ignoreEmpty, true)
var key = defined(argv.key, true)
var dryRun = defined(argv.dryRun, false)
var delim = defined(argv.separator, ',')
var isCsv = defined(argv.csv, false)

if (!argv.c) usage()

var updated = 0
var db = mongojs(argv.d || 'test', [argv.c])
var collection = db.collection(argv.c)

function handle(data, done) {
  update(collection, data.record, {
    ignoreEmpty: ignoreEmpty,
    key: key,
    dryRun: dryRun
  }, function (err, doc) {
    updated += doc.n
    done(err, doc)
  })
}

queue = async.queue(handle, argv.j || 20)

var parser = isCsv ? csv.bind(null, { separator: delim })
                   : EJSON.createParseStream.bind(null, false)

process.stdin
.pipe(parser())
.on('data', function(record) {
  queue.push({ record: record }, function(err){
    if (err)
      console.error('ERROR: %s', err)
  })
})

queue.drain = function(){
  console.error('%s documents updated', updated)
  debug('draining')
  db.close()
}

function usage (msg) {
  console.log('mongomerge [options]')
  console.log('')
  console.log('  required options')
  console.log('')
  console.log('    -c <collection>  mongodb collection')
  console.log('')
  console.log('  additional options')
  console.log('')
  console.log('    -d [database]    mongodb database')
  console.log('    --csv            parse a csv (default: ejson)')
  console.log("    --dryRun         don't update anything, just print actions")
  console.log('    -k,--key         primary key to use (default: _id)')
  console.log('    -s,--separator   csv separator')
  console.log('')
  process.exit(1)
}

function fail(msg) {
  console.error(msg)
  process.exit(1)
}
